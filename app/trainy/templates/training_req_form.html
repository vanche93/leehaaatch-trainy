{% load crispy_forms_tags %}

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Запись на тренировку</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <!-- Карточка тренировки -->
          <div class="card mb-4 shadow-sm">
            {% if training.image %}
            <img
              src="{{ training.image.url }}"
              class="card-img-top img-fluid"
              alt="{{ training.name }}"
            />
            {% endif %}
            <div class="card-body">
              <h3 class="card-title">{{ training.name|default:"" }}</h3>
              {% if training.description %}
              <p class="card-text text-muted">{{ training.description }}</p>
              {% endif %}
              <p class="card-text">
                <strong>Дата:</strong> {{ training.date }}
              </p>
            </div>
          </div>
          {% if training.status == 'open' %}
          <!-- Форма запроса -->
          <div class="card mb-4 shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Записаться на тренировку</h5>
              <form method="post">
                {% csrf_token %} {{ form|crispy }}
                <input type="hidden" name="tg_init_data" id="tg_init_data" />
                <input type="hidden" name="tgWebAppStartParam" value="{{ training.id }}">
              </form>
            </div>
          </div>
          {% endif %}
          {% if training.req_sum %}
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Отправленые запросы на тренировку</h5>
              <div class="list-group list-group-flush">
                {% for row in training.req_sum %}
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="fw-semibold">{{ row.topic.name }}</div>
                    </div>
                    <div class="mt-2 d-flex flex-wrap gap-2">
                      {% for time_obj, cnt, percent in row.times %}
                        {% if percent >= 75 %}
                          <span class="badge bg-warning">{{ time_obj }} - {{ cnt }}/{{ training.max_participants }}</span>
                        {% elif percent >= 50 %}
                          <span class="badge bg-success">{{ time_obj }} - {{ cnt }}/{{ training.max_participants }}</span>
                        {% elif percent >= 25 %}
                          <span class="badge bg-primary">{{ time_obj }} - {{ cnt }}/{{ training.max_participants }}</span>
                        {% else %}
                          <span class="badge bg-light text-muted border">{{ time_obj }} - {{ cnt }}/{{ training.max_participants }}</span>
                        {% endif %}
                        
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const tg = window.Telegram.WebApp;
      {% if messages %}
        Telegram.WebApp.showAlert("{% for message in messages %} {{ message }} {% endfor %}", () => {
          Telegram.WebApp.close();
        });
      {% endif %}
      tg.MainButton.setText("Отправить");
      tg.MainButton.show();
      tg.MainButton.onClick(() => {
        document.querySelector("form").submit();
      });
      document.getElementById("tg_init_data").value = tg.initData;
    </script>
  </body>
</html>
